# 智能合约和先知机

智能合约一般都是跑在区块链的虚拟机上面，如果不能从已有的Web世界获取数据，那就只能做一个封闭的计算系统而已，并不能根据已有Web世界的信息作出智能的仲裁。所谓智能合约中的智能，应该更多是根据链下Web数据来作出判断，而不仅仅是根据链上数据作出判断。

从应用场景来看，实在有太多的场景都是需要根据Web外部事件，然后根据智能合约的逻辑输出相应的结果。例如，根据农产品价格情况来支付投保人赔款的农产品价格险保单；根据航班晚点信息来支付航班延误保险投保人赔款...

这个在传统的IT行业，处理起来是比较简单的事情，但是到区块链的智能合约上，处理起来却不是那么容易。存在的问题是明显的，区块链上的智能合约是完全没有中心权威的，而区块链又有众多分散的节点，要想在区块链上的智能合约取链下数据做仲裁判断，有两个明显的问题：共识问题和受信任方问题。

### 共识问题

智能合约之所以能正常运行，是因为底层的区块链解决了每个节点数据精确一致的难题。如果节点之间对数据状态有歧义，整个系统就无法可信稳定运行了。如果智能合约直接通过http请求获取外部数据，那区块链上各个节点都要分布式去发送http请求获取数据，那么不能够保证同时发送出http请求，那么返回的数据是否能够一致就不能保证，因此对应的各个节点处理过后的结果就会出现歧义，在这种情况下，整个区块链的信任基础就会奔溃，无法达成共识。

既然无法通过智能合约自己去获取数据，那就需要一个代理人，早早将数据准备好放在区块链上，这个代理人就是第三方，由第三方发送一笔区块链交易，在交易中附加需要的数据 ，交易会将数据嵌入区块，并同步到每个节点，从而保证数据的完全一致，因此可以用于智能合约的计算。总之就是不能通过智能合约将数据拉取进区块链，而是由第三方将数据推送进区块链。

### 受信任方问题

为了解决共识问题，引入了一个第三方的代理人，通过代理人将外部数据推送到区块链。这个时候智能合约和外部的交互就要依赖与第三方，那么第二个问题随之而来，如何才能信任这个第三方代理人呢？

- 第三方在数据传输中私自篡改数据，数据在通信过程中被hack掉怎么办？
- 如何审计第三方是否从正确的地址获取数据？

### Oracle

主角限量登场，Oracle，中文翻译成先知机或者预言机。先知机是一种可信任的实体，通过签名引入关于外部世界状态的信息，从而允许确定的智能合约对不确定的外部世界作出反应。先知机具有不可篡改，服务稳定，可审计等特点，并具有经济激励机制以保证运行的动力。

分类：

- 单一模型

只包含一个先知机，这一个先知机是可信任的，会正确执行代码，合约的参与者确信它不会与合约的某一参与方勾结，可以简单理解单一先知机类似软件即服务提供者。对于大部分应用，单一模型就足够安全，并且经济实惠。目前单一模型的实例是[Oraclize]("http://www.oraclize.it")。

- 多重模型

多重模型包含多个预言机，甚至是预言机网络。主要是为了应对高价值的资产处理，需要更高的可信任度，这个时候就需要用到多重模型。在多重模型中，代码的执行分布在若干独立的先知机中，例如10个，设置一个可信任临界值，比如7，那就需要7个先知机的结果达成一致才能达成共识，合同才能执行。

### 单一模型先知机运作方式

##### Oraclize

Oraclize是一个独立的服务提供商，目前提供免费的数据输送服务，其目的是在区块链和互联网之间建立一道可信的数据网关，其目标是打破智能合约获取数据的束缚，在保证可信的情况下，使其具有访问互联网数据的能力。Oraclize的出发点不是打造一个权威的可信任中心，而是通过提供多种加密证明方法，构建可信的先知机。其运行状态如下图：

![](http://s7.sinaimg.cn/middle/002RSgYjzy7kiPO4Rpk16&690)

如上图，多种区块链可以通过Oraclize有效的访问互联网API，保护其DAPP的安全性和健壮性。以太坊是用Solidity语言来开发，其智能合约只能够存取访问链上的信息，而Oraclize作为一个数据传送者，可以在以太坊的DAPPs与Web APIs之间提供可靠连接，让基于智能合约的DAPP应用可信的取得外部信息和数据。

网友给了一张示意图，非常感谢。

![](https://img-blog.csdn.net/20170822111958189?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc3BvcnRzaGFyaw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

Oraclize在以太坊上部署了一个名为usingOraclize的智能合约，如果需要其数据访问服务，只需要在自己的智能合约中引用该智能合约，然后根据API文档中描述的方法进行相应的调用即可。

如果基于以太坊构建了自己的私有链或者联盟链，Oraclize在Github上提供数据服务的开源智能合约代码，通过部署后，一样可以像公有链一样调用。

Oraclize提供了多种数据源服务器，包含URL访问，数据搜索引擎，区块链内容数据，IPFS文件访问等，其中URL访问和区块链内容数据提供了基于TLSNotary的可信任证明技术。

###### URL访问服务

该服务可用于访问互联网的API或者网页，首先用户向Oraclize提供想要的访问的URL地址，并设定GET/POST的方法和相关的参数。Oraclize根据用户的设定，自动获取URL的内容，然后发送数据到区块链上的Oraclize的服务智能合约上，通过该智能合约转发到用户的智能合约上。整个过程中，用户可选择开启或关闭TLSNotary的可信证明。这样的应用场景很多，比如通过Random.org网站获取真正的随机数、获取航班运行情况用于航班延误险的自动计算和支付、链上身份认证系统、去中心化的博彩系统、去中心化的预测市场（如体育运动比赛结果或竞选活动）等等。

###### 区块链内容数据

区块链内容服务可以让智能合约快速访问某一区块链的相关数据，实际上，一方面早期的区块链上的脚本并不能访问自身的内容，比如比特币的脚本本身不能访问比特币的区块链数据。另一方面，不同区块链上的脚本或智能合约有跨链访问数据的需求，以完成更复杂的功能。区块链内容数据一般来说都是从互联网上的区块链浏览器获取，区块链浏览器一般都会提供各种API用于获取区块哈希、区块内容，交易内容、用户余额等多种信息，从本质上来说，区块链内容数据也是URL访问服务的一种特殊类型。

除此以外，Oraclize还提供搜索引擎数据服务、IPFS分布式数据服务、加解密服务、链下计算服务等，原理本质上没有区别。

### 多重模型先知机运作方式

一个可靠的多重模型先知机，遵循博弈原理，有经济激励机制和惩罚措施，越多的节点参与，其真实性越高。当数据输入时，网络需要保证参与者节点无法知晓其他参与者节点的数据，然后各个节点将数据输入智能合约，智能合约对于价格等连续数据将选择最接近中位数的数据，如果是二元数据则统计得票最多的结果，最后对提供正确数据的节点进行奖励。

单一模型应对绝大多数的DAPP，但对于可信任度高的DAPP，需要多重模型先知机，也需要面对女巫攻击（Sybil attack）和共谋攻击（collusion attack）。

这两种攻击本质上都是通过控制多个节点来伪造数据干扰最终结果。防范的方法有下面几点：

- 鼓励更多的节点参与数据反馈
- 让每个节点的权重尽量平均
- 提高节点的接入成本，比如需要一定的押金
- 需要一定的激励和惩罚措施



